<%
require_once("wces/oldquestions.inc");

//options is an array of booleans with these keys:
// - "standard"
// - "custom"

$ABETCONDITION = "qs.abet != 0";
$STANDARDCONDITION = "qs.type = 'public'";
$CUSTOMCONDITION = "qs.type = 'private'";
$RATINGSCONDITION = "(LENGTH(qs.MC1) > 0 OR LENGTH(qs.MC2) > 0 OR LENGTH(qs.MC3) > 0 OR LENGTH(qs.MC4) > 0 OR LENGTH(qs.MC5) > 0 OR LENGTH(qs.MC6) > 0 OR LENGTH(qs.MC7) > 0 OR LENGTH(qs.MC8) > 0 OR LENGTH(qs.MC9) > 0 OR LENGTH(qs.MC10) > 0)";
$TEXTCONDITION = "(LENGTH(qs.FR1) > 0 OR LENGTH(qs.FR2) > 0)";
 
function report_makequeries($db, $options, $criteria, $groups, $sort, &$header, &$listclasses, &$listprofessors, &$ratings, &$abet, &$responses, &$tas)
{
  global $ABETCONDITION, $STANDARDCONDITION, $CUSTOMCONDITION, $RATINGSCONDITION, $TEXTCONDITION, $TAQUESTIONS;

  db_exec("
    CREATE TEMPORARY TABLE filledclasses
    (
      classid INTEGER NOT NULL,
      questionperiodid INTEGER NOT NULL,
      questionsetid INTEGER,
      response INTEGER,
      UNIQUE KEY(classid, questionperiodid, questionsetid)
    )
  ", $db, __FILE__, __LINE__);
  
  db_exec("
    CREATE TEMPORARY TABLE mastertable
    (
      masterid INTEGER AUTO_INCREMENT,
      clusterid INTEGER,
      classid INTEGER,
      courseid INTEGER,
      questionperiodid INTEGER,
      professorid INTEGER,
      departmentid INTEGER,
      cname TINYTEXT,
      ccode TINYTEXT,
      section CHAR(3),
      year YEAR,
      semester ENUM('spring','summer','fall'),
      pfname TINYTEXT,
      plname TINYTEXT,
      students INTEGER,
      response INTEGER,
      PRIMARY KEY(masterid),
      UNIQUE KEY(classid,questionperiodid)
    )  
  ", $db, __FILE__, __LINE__);

  $where = "";
    
  if ($criteria["topics"])
    addwhere($where,"topicid IN (" . implode(", ", $criteria["topics"]) . ")");
  
  if ($criteria["questionperiods"])
    addwhere($where,"questionperiodid IN (" . implode(", ", $criteria["questionperiods"]) . ")");
  
  debugout($tas ? "trie" : "foulse");
  
  if ($tas)
    db_exec("INSERT INTO filledclasses(classid, questionperiodid) SELECT classid, questionperiodid FROM taratings $where GROUP BY classid, questionperiodid", $db, __FILE__, __LINE__);

  if ($options["custom"] && $options["standard"])
    $typecondition = "";
  else if ($options["custom"])
    $typecondition = $CUSTOMCONDITION;
  else if ($options["standard"])
    $typecondition = $STANDARDCONDITION;
  else // defensive programming, this is bad in many other ways as well
    $typecondition = "0";
    
  $formcondition = $responses ? "($RATINGSCONDITION OR $TEXTCONDITION)" : "($RATINGSCONDITION)";
  
  if ($abet || $options["standard"] || $options["custom"])
  {
    $conditions = array();
    if ($abet)
      $conditions[] = "$ABETCONDITION";
  
    if($options["standard"] || $options["custom"])
      $conditions[] = $typecondition ? "($typecondition AND $formcondition)" : $formcondition;
  
    if (count($conditions) > 0)
      addwhere($where,'(' . implode(" OR ",$conditions) . ')');
    
    db_exec("
      INSERT INTO filledclasses(classid, questionperiodid, questionsetid, response)
      SELECT a.classid, a.questionperiodid, a.questionsetid, a.responses
      FROM answersets AS a
      INNER JOIN questionsets AS qs ON (qs.questionsetid = a.questionsetid)
      $where", $db, __FILE__, __LINE__);
  }
    
  $where = "";
  
  if ($criteria["departments"])
    addwhere($where, "d.departmentid IN (" . implode(",", $criteria["departments"]) . ")");
    
  if ($criteria["professors"])
    addwhere($where, "p.professorid IN (" . implode(",", $criteria["professors"]) . ")");
    
  if ($criteria["courses"])
    addwhere($where, "c.courseid IN (" . implode(",", $criteria["courses"]) . ")");
    
  if ($groups["classes"])
    $groups["courses"] = $groups["professors"] = $groups["departments"] = true;

  $s = $sort;
  foreach($groups as $group => $checked)
  {
    if (!$checked)
    foreach($s as $k => $v)
      if ($group == $v) unset($s[$k]);
  }
    
  $sort = array_values(array_unique(array_merge($s,$sort)));
  
  $order = "";
  foreach($sort as $item)
  switch($item)
  {
    case "questionperiods":
      addorder($order, "cl.year, cl.semester, fc.questionperiodid");
    break;
    case "departments":
      addorder($order, "d.code");
    break;
    case "professors":
      addorder($order, "plname, pfname");
    break;
    case "courses":
      addorder($order, "c.name");
    break;
    case "classes":
      addorder($order, "ccode, cl.section");
    break;
  }

  $tables = 
    "FROM filledclasses AS fc
    INNER JOIN classes AS cl ON (cl.classid = fc.classid)
    INNER JOIN courses AS c ON (c.courseid = cl.courseid)
    INNER JOIN subjects AS s ON (s.subjectid = c.subjectid)
    LEFT JOIN departments AS d ON (cl.departmentid = d.departmentid)
    LEFT JOIN professors AS p ON (p.professorid = cl.professorid)";
    
  $insert = db_exec("
    INSERT INTO mastertable(classid,courseid,questionperiodid,professorid,departmentid,
      cname, ccode, section, year, semester, plname, pfname, students, response)
    SELECT fc.classid, cl.courseid, fc.questionperiodid, cl.professorid, d.departmentid,
      c.name, CONCAT(s.code, c.code) AS ccode, cl.section, cl.year, cl.semester,
      SUBSTRING_INDEX(p.name,' ',-1) AS plname,
      SUBSTRING(p.name,1,LENGTH(p.name)-LOCATE(' ',REVERSE(p.name))) AS pfname,
      cl.students, MAX(fc.response)
    $tables $where GROUP BY fc.classid, fc.questionperiodid $order
  ",$db,__FILE__,__LINE__);

  $group = "";
  if ($groups["classes"]) addgroup($group, "classid");
  if ($groups["courses"]) addgroup($group, "courseid");
  if ($groups["professors"]) addgroup($group, "professorid");
  if ($groups["departments"]) addgroup($group, "departmentid");
  if ($groups["questionperiods"]) addgroup($group, "questionperiodid");
  
  $counts = db_exec("SELECT COUNT(*) AS number FROM mastertable $group ORDER BY masterid", $db, __FILE__, __LINE__);
  $masterid = 0;
  $clusterid = 0;
  while($row = mysql_fetch_assoc($counts))
  {
    ++$clusterid;
    $emasterid = $masterid + $row["number"];
    mysql_query("UPDATE mastertable SET clusterid = $clusterid WHERE $masterid < masterid AND masterid <= $emasterid", $db) or die("bad,bad,bad");
    $masterid = $emasterid;
  }

  if ($header)
  {
    $columns = "";
    if ($groups["departments"])
      addcolumn($columns, "d.departmentid, d.name AS dname, d.code AS dcode");
    if ($groups["questionperiods"])
      addcolumn($columns, "CONCAT(qp.semester, ' ' , qp.year, ' ' , qp.description) AS qpname");
    $header = new SegmentedQuery(db_exec("
      SELECT ml.clusterid, SUM(ml.students) AS students, SUM(ml.response) AS response,
        $columns
      FROM mastertable AS ml
      LEFT JOIN departments AS d ON d.departmentid = ml.departmentid
      LEFT JOIN questionperiods AS qp ON qp.questionperiodid = ml.questionperiodid
      GROUP BY ml.clusterid
      ORDER BY ml.clusterid
    ", $db, __FILE__, __LINE__), "clusterid");
    $header->advance();
  }  

  if ($listclasses)
  {
    $listclasses = new SegmentedQuery(db_exec("
      SELECT clusterid, ccode, section, year, semester, cname, classid FROM mastertable AS ml
      GROUP BY clusterid, classid
      ORDER BY clusterid, ccode, section
    ", $db, __FILE__, __LINE__), "clusterid");
    $listclasses->advance();
  }
  
  if ($listprofessors)
  {
    $listprofessors = new SegmentedQuery(db_exec("
      SELECT clusterid, plname, pfname, professorid
      FROM mastertable
      GROUP BY clusterid, classid
      ORDER BY clusterid, plname, pfname
    ", $db, __FILE__, __LINE__), "clusterid");
    $listprofessors->advance();
  }
  
  if ($ratings)
  {
    $columns = "";
    $choices = array("a","b","c","d","e");
    for($i = 1; $i <= 10; ++$i)
    {
      $columns .= ", qs.MC$i";
      foreach($choices as $choice)
        $columns .= ", SUM(a.MC$i$choice) AS MC$i$choice";
    };

    $cnd = $typecondition ? "AND $typecondition" : "";

    $ratings = new SegmentedQuery(db_exec("
      SELECT ml.clusterid, qs.displayname $columns
      FROM mastertable AS ml
      INNER JOIN filledclasses AS fc ON ml.classid = fc.classid AND ml.questionperiodid = fc.questionperiodid
      INNER JOIN answersets AS a ON a.questionsetid = fc.questionsetid AND a.classid = fc.classid AND a.questionsetid = fc.questionsetid
      INNER JOIN questionsets AS qs ON qs.questionsetid = a.questionsetid
      WHERE $RATINGSCONDITION $cnd      
      GROUP BY clusterid, qs.questionsetid
      ORDER BY clusterid, qs.questionsetid
    ", $db, __FILE__, __LINE__), "clusterid");
    $ratings->advance();
  }  
    
  if ($abet)
  {
    $columns = "";
    $choices = array("a","b","c","d","e","f");
    for($i = 1; $i <= 20; ++$i)
      foreach($choices as $choice)
        $columns .= ", SUM(a.ABET$i$choice) AS ABET$i$choice";
    $abet = new SegmentedQuery(db_exec("
      SELECT ml.clusterid, qs.displayname $columns
      FROM mastertable AS ml
      INNER JOIN filledclasses AS fc ON ml.classid = fc.classid AND ml.questionperiodid = fc.questionperiodid
      INNER JOIN answersets AS a ON a.questionperiodid = ml.questionperiodid AND a.classid = ml.classid AND a.questionsetid = fc.questionsetid
      INNER JOIN questionsets AS qs ON qs.questionsetid = a.questionsetid
      WHERE $ABETCONDITION
      GROUP BY ml.clusterid ORDER BY ml.clusterid
    ", $db, __FILE__, __LINE__), "clusterid");
    $abet->advance();
  };

  if ($responses)
  {
    $cnd = $typecondition ? "AND $typecondition" : "";
    $responses = new SegmentedQuery(db_exec("
      SELECT ml.clusterid, qs.FR1 AS qsFR1, qs.FR2 AS qsFR2, a.FR1, a.FR2, ml.ccode, ml.section, ml.year, ml.semester, ml.cname, ml.classid, ml.plname, ml.pfname, ml.professorid
      FROM mastertable AS ml
      INNER JOIN filledclasses AS fc ON ml.classid = fc.classid AND ml.questionperiodid = fc.questionperiodid
      INNER JOIN answersets AS a ON a.questionsetid = fc.questionsetid AND a.classid = fc.classid AND a.questionsetid = fc.questionsetid
      INNER JOIN questionsets AS qs ON qs.questionsetid = a.questionsetid
      WHERE $TEXTCONDITION $cnd AND (LENGTH(a.FR1) > 0 OR LENGTH(a.FR2) > 0)
      GROUP BY ml.clusterid, a.answersetid ORDER BY ml.clusterid, ml.ccode, ml.year, ml.semester, ml.section
    ", $db, __FILE__, __LINE__), "clusterid");   
    $responses->advance();
  };
  
  if ($tas)
  {
    $columns = "";
    foreach($TAQUESTIONS as $column => $description)
      $columns .= ", ta.$column";

    $tas = new SegmentedQuery(db_exec("
      SELECT ml.clusterid, ta.name, ta.tauserid, ta.comments $columns, ml.ccode, ml.section, ml.year, ml.semester, ml.cname, ml.classid
      FROM mastertable AS ml
      INNER JOIN taratings AS ta ON ta.classid = ml.classid AND ta.questionperiodid = ml.questionperiodid
      GROUP BY ml.clusterid, ta.taratingid ORDER BY ml.clusterid, ml.ccode, ml.year, ml.semester, ml.section, ta.name
    ", $db, __FILE__, __LINE__), "clusterid");
    $tas->advance();
  };
  return $clusterid;
}

//---------------------------------------------------------------------------------------------
// This function produces report "pages" from the results of selectmonster query
// 
// The output can be html, plain text or both
// I am generating both types of reports in a single function
// to facilitate situations where both formats of a report are needed at
// once, such as when we want to make multiformat MIME messages.

// possible options: 
// - "pies"

function report_makepage(&$outtext, &$outhtml, $options, $groups, &$header, &$listclasses, &$listprofessors, &$ratings, &$abet, &$responses, &$tas)
{
  global $server_wcespath, $TAQUESTIONS, $TAVALUES, $ABETQUESTIONS;
  
  $pagetext = "";
  $pagehtml = "";

  //////////////////////////////////// PAGE HEADER /////////////////////////////////////
  
  $students = $response = $clusterid = $dname = $dcode = $semester = $year = $description = "";
  extract($header->row);
  
  if ($outhtml)
  {
    $pagehtml .= "<h4>On this page</h4>\n";
    $pagehtml .= "<table border=0>\n";
    if ($groups["questionperiods"]) $pagehtml .= "<tr><td>Question Period:</td><td><b>" . ucfirst($qpname) . "</b></td></tr>\n";
    if ($groups["departments"]) $pagehtml .= "<tr><td>Department:</td><td><b>$dname ($dcode)</b></td></tr>\n";
  }

  if ($outtext)
  {
    $pagetext .= "Included on this page:\n\n";
    if ($groups["questionperiods"]) $pagetext .= " - Question Period: " . ucfirst($qpname) . "\n";
    if ($groups["departments"]) $pagetext .= " - Department: $dname ($dcode)\n";
  }

  if ($listclasses && $clusterid == $listclasses->row["clusterid"])
  {
    do
    {
      $ccode = $cname = $section = $year = $semester = $classid = "";
      extract($listclasses->row);
      $classname = "$ccode $cname Section $section";
      if ($groups["questionperiods"])
        $classname .= " " . ucfirst($semester) . " $year";
      if ($outhtml)
        $pagehtml .= "<tr><td>Class:</td><td><b><a href=\"${server_wcespath}administrators/info.php?classid=$classid\">$classname</a></b></td></tr>\n";
      if ($outtext)
        $pagetext .= " - Class: $classname\n"; 
    }
    while($listclasses->advance());
  }  

  if ($listprofessors && $clusterid == $listprofessors->row["clusterid"])
  {
    do
    {
      $plname = $pfname = $professorid = "";
      extract($listprofessors->row);
      if($pfname || $plname) 
      {  
        $profname = "$pfname $plname";
        if ($outhtml) $pagehtml .= "<tr><td>Professor:</td><td><b><a href=\"${server_wcespath}administrators/info.php?professorid=$professorid\">$profname</a></b></td></tr>\n";
        if ($outtext) $pagetext .= " - Professor: $profname\n"; 
      }  
    }
    while($listprofessors->advance());
  }

  if ($outhtml) $pagehtml .= "</table>\n";

  //////////////////////////////// RESPONSE STATISTICS /////////////////////////////////
  
  if ($pagetext)
  {  
    $pagetext .= "\nResponse Statistics:\n\n";
    $pagetext .= " - Total Students: $students\n";
    $pagetext .= " - Students Evaluated: $response\n\n";
  }

  if ($outhtml)
  {
    $pagehtml .= "<h4>Response Statistics</h4>";
    $pagehtml .= "<table border=0>\n";
    $pagehtml .= "<tr><td>Total Students:</td><td><b>$students</b></td></tr>\n";
    $pagehtml .= "<tr><td>Students Evaluated:</td><td><b>$response</b></td></tr>\n";
    $pagehtml .= "</table>\n";
    if ($options["pies"]) $pagehtml .= '<img src="' . "${server_wcespath}media/graphs/susagegraph.php?blank=" . ($students-$response) . "&filled=$response\" width=200 height=200><img src=\"${server_wcespath}media/graphs/susagelegend.gif\" width=147 height=31>";
  }

  $header->advance();

  ///////////////////////////////// COURSE RATINGS /////////////////////////////////////

  $choices = array("a","b","c","d","e");

  if ($ratings && $clusterid == $ratings->row["clusterid"])
  do
  {
    if ($outtext)
    {
      $pagetext .= $ratings->row["displayname"] . "\n\n";

      $pagetext .= "5 = Excellent, 4 = Very Good, 3 = Satisfactory, 2 = Poor, 1 = Disastrous\n\n";
        
      $format =Array(30,"center","center","center","center","center","center","center","center");
      $table = Array(Array("Question Text","5","4","3","2","1","Avg","Mode","SD"));
  
      for ($i = 1; $i <= 10; ++$i)
      if ($ratings->row["MC$i"])
      {
        $datums = array(5 => $ratings->row["MC${i}a"], 4 => $ratings->row["MC${i}b"], 3 => $ratings->row["MC${i}c"], 2 => $ratings->row["MC${i}d"], 1 => $ratings->row["MC${i}e"]);
        
        $mode = report_mode($datums);
        $avg = report_avg($datums);
        $sd = report_sd($datums,$avg);

        $row = Array($ratings->row["MC$i"]);
        foreach($choices as $choice)
          array_push($row,$ratings->row["MC$i$choice"]);
        array_push($row,round($avg,1)); 
        array_push($row,$mode);
        array_push($row,round($sd,1));
        array_push($table,$row);
      };
      $pagetext .= texttable($table,$format) . "\n\n";
    }
    
    if ($outhtml)
    {
      $first = true;
      for($i = 1; $i <= 10; ++$i)
      {
        if ($ratings->row["MC$i"])
        {
          if ($first)
          {
            $first = false;
            $pagehtml .= "<h4>" . $ratings->row["displayname"] . "</h4>\n";
            $pagehtml .= "<table border=1 RULES=ALL FRAME=VOID>\n";
            $pagehtml .= "<tr>\n";
            $pagehtml .= "  <td>&nbsp;</td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/50.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/40.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/30.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/20.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/10.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/avg.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/mode.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/sd.gif\"></center></td>\n";
            $pagehtml .= "  <td width=120><p><b>Average (Graphical)</p></b></td>\n";
            $pagehtml .= "</tr>";
          };
          $pagehtml .= "<tr>\n";
          $pagehtml .= "  <td>" . $ratings->row["MC$i"] . "</td>\n";
  
          foreach($choices as $choice)
            $pagehtml .= ("  <td>" . $ratings->row["MC$i$choice"] . "</td>\n");

          $datums = array(5 => $ratings->row["MC${i}a"], 4 => $ratings->row["MC${i}b"], 3 => $ratings->row["MC${i}c"], 2 => $ratings->row["MC${i}d"], 1 => $ratings->row["MC${i}e"]);
  
          $mode = report_mode($datums);
          $avg = report_avg($datums);
          $sd = report_sd($datums,$avg);
  
          $pagehtml .= "  <td>" . round($avg,2) . "</td>\n";
          $pagehtml .= "  <td>" . round($mode,2) . "</td>\n";
          $pagehtml .= "  <td>" . round($sd,2) . "</td>\n";
          $pagehtml .= "  <td>" . report_meter(round($avg * 20)) . "</td>\n";
          $pagehtml .= "</tr>\n";
        };  
      };
      if (!$first) $pagehtml .= "</table>\n";
    };
  }
  while($ratings->advance());

  ////////////////////////////////// ABET RATINGS /////////////////////////////////////

  global $TAQUESTIONS;
  $choices = array("a","b","c","d","e","f");
  
  if ($abet && $clusterid == $abet->row["clusterid"])
  do
  {
    if ($outtext)
    {
      $pagetext .= $abet->row["displayname"] . "\n\n";

      $pagetext .= "To what degree did this course enhance your ability to ...\n";
      $pagetext .= "0 = not at all, 5 = a great deal\n\n";
        
      $format =Array(30,"center","center","center","center","center","center","center","center","center");
      $table = Array(Array("Question Text","0","1","2","3","4","5","Avg","Mode","SD"));
  
      for ($i = 1; $i <= 10; ++$i)
      if ($abet->row["ABET${i}a"] || $abet->row["ABET${i}b"] || $abet->row["ABET${i}c"] || $abet->row["ABET${i}d"] || $abet->row["ABET${i}e"] || $abet->row["ABET${i}f"])
      {
        $datums = array(0 => $abet->row["ABET${i}a"], 1 => $abet->row["ABET${i}b"], 2 => $abet->row["ABET${i}c"], 3 => $abet->row["ABET${i}d"], 4 => $abet->row["ABET${i}e"], 5 => $abet->row["ABET${i}f"]);
        
        $mode = report_mode($datums);
        $avg =  report_avg ($datums);
        $sd =   report_sd  ($datums, $avg);

        $row = array($ABETQUESTIONS[$i]);
        foreach($choices as $choice)
          array_push($row,$abet->row["ABET$i$choice"]);
        array_push($row,round($avg,1)); 
        array_push($row,$mode);
        array_push($row,round($sd,1));
        array_push($table,$row);
      
      };
      $pagetext .= texttable($table,$format) . "\n\n";
    }
    
    if ($outhtml)
    {
      $first = true;
      for($i = 1; $i <= 10; ++$i)
      {
        if ($abet->row["ABET${i}a"] || $abet->row["ABET${i}b"] || $abet->row["ABET${i}c"] || $abet->row["ABET${i}d"] || $abet->row["ABET${i}e"] || $abet->row["ABET${i}f"])
        {
          if ($first)
          {
            $first = false;
            $pagehtml .= "<h4>ABET Questions</h4>\n";
            
            $pagehtml .= "<p><strong>To what degree did this course enhance your ability to ...</strong><br>\n";
            $pagehtml .= "<i>0 = not at all, 5 = a great deal</i></p>\n\n";

            $pagehtml .= "<table border=1 RULES=ALL FRAME=VOID>\n";
            $pagehtml .= "<tr>\n";
            $pagehtml .= "  <td>&nbsp;</td>\n";
            $pagehtml .= "  <td width=20><center><strong>0</strong></center></td>\n";
            $pagehtml .= "  <td width=20><center><strong>1</strong></center></td>\n";
            $pagehtml .= "  <td width=20><center><strong>2</strong></center></td>\n";
            $pagehtml .= "  <td width=20><center><strong>3</strong></center></td>\n";
            $pagehtml .= "  <td width=20><center><strong>4</strong></center></td>\n";
            $pagehtml .= "  <td width=20><center><strong>5</strong></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/avg.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/mode.gif\"></center></td>\n";
            $pagehtml .= "  <td width=20><center><img src=\"${server_wcespath}/media/report/sd.gif\"></center></td>\n";
            $pagehtml .= "  <td width=120><p><b>Average (Graphical)</p></b></td>\n";
            $pagehtml .= "</tr>";
          };
          $pagehtml .= "<tr>\n";
          $pagehtml .= "  <td>" . $ABETQUESTIONS[$i] . "</td>\n";
  
          foreach($choices as $choice)
            $pagehtml .= ("  <td>" . $abet->row["ABET$i$choice"] . "</td>\n");
  
          $datums = array(0 => $abet->row["ABET${i}a"], 1 => $abet->row["ABET${i}b"], 2 => $abet->row["ABET${i}c"], 3 => $abet->row["ABET${i}d"], 4 => $abet->row["ABET${i}e"], 5 => $abet->row["ABET${i}f"]);
          
          $mode = report_mode($datums);
          $avg = report_avg  ($datums);
          $sd = report_sd    ($datums, $avg);
  
          $pagehtml .= "  <td>" . round($avg,2) . "</td>\n";
          $pagehtml .= "  <td>" . round($mode,2) . "</td>\n";
          $pagehtml .= "  <td>" . round($sd,2) . "</td>\n";
          $pagehtml .= "  <td>" . report_meter(round($avg * 20)) . "</td>\n";
          $pagehtml .= "</tr>\n";
        };  
      };
      if (!$first) $pagehtml .= "</table>\n";
    };
  }
  while($abet->advance());
  
  ///////////////////////////////// TEXT RESPONSES /////////////////////////////////////
  
  $first = true;
  if ($responses && $clusterid == $responses->row["clusterid"])
  {
    if ($outhtml) $pagehtml .= "<h4>Text Responses</h4>";
    if ($outtext) $pagetext .= "Text Responses\n\n"; 
    do
    {
      $plname = $pfname = $professorid = $ccode = $name = $section = $year = $semester = $classid = "";
      extract($responses->row);
      $profname = $classname = "";
      if (!$groups["classes"])
      {
        $classname = "$ccode $name Section $section";
        if ($groups["questionperiods"])
        $classname .= " " . ucfirst($semester) . " $year";
      }
          
      if (!$groups["classes"] && ! $groups["professors"])
        $profname = "$pfname $plname"; 
          
      if ($outhtml && $classname) $pagehtml .= "<h5><a href=\"${server_wcespath}administrators/info.php?classid=$classid\">$classname</a>" . ($profname ? " - Professor <a href=\"${server_wcespath}administrators/info.php?professorid=$professorid\">$profname</a>" : "") . "</h5>";
      if ($outtext && $classname) $pagetext .= "$classname" . ($profname ? " - Professor $profname" : "") . "\n\n";
      
      for($j = 1; $j <= 2; ++$j)
      if ($responses->row["qsFR$j"] && $responses->row["FR$j"])
      {
        if ($outhtml)
        {
          $pagehtml .= "<h5>" . $responses->row["qsFR$j"] . "</h5>";
          $pagehtml .= "<UL><LI>";
          $pagehtml .= nl2br(stripcslashes(str_replace("\t","</LI><LI>",trim($responses->row["FR$j"]))));
          $pagehtml .= "</LI></UL>";        
        }
        if ($outtext)
        {
           $pagetext .= wordwrap($responses->row["qsFR$j"],76) . "\n\n";
           $pagetext .= " - ";
           $pagetext .= wordwrap("    " . stripslashes(stripcslashes(str_replace("\t","\n - ",trim($responses->row["FR$j"])))),76);
           $pagetext .= "\n\n";
        }
      };
    }
    while($responses->advance());
  }
  /////////////////////////////////// TA RATINGS ///////////////////////////////////////

  if ($tas && $clusterid == $tas->row["clusterid"])
  {
    $pagehtml .= "<h4>TA Ratings</h4>\n<table border=1>\n<tr>\n  <td>Name</td>\n";
    foreach($TAQUESTIONS as $question)
      $pagehtml .= "  <td><div style=\"writing-mode:tb-rl\"><b>$question</b></div></td>\n";
    $pagehtml .= "<td><b>Comments</b></td><td><b>Student #</b></td></tr>\n";  
    $lclassid = 0;
    do
    {
      if (!$groups["classes"] && $lclassid != $tas->row["classid"])
      {
        $classid = $ccode = $name = $section = "";
        extract($tas->row);
        $classname = "$ccode $name Section $section";
        if ($groups["questionperiods"])
          $classname .= " " . ucfirst($semester) . " $year";
        $pagehtml .= "<tr><td colspan=8 align=center><b><a href=\"info.php?classid=$classid\">$classname</a></b></td></tr>\n";
        $lclassid = $classid;
      }

      $name = $tas->row["name"];
      if (!$name) $name = "<i>All TAs</i>";
      $pagehtml .= "<tr>\n  <td>$name</td>";
      foreach($TAQUESTIONS as $field => $question)
        $pagehtml .= "  <td>" . $tas->row[$field] . "</td>\n";
      $pagehtml .= "<td>" . ($tas->row["comments"] ? $tas->row["comments"] : "&nbsp;") . "</td><td>" . $tas->row["tauserid"] . "</td></tr>\n";
    }
    while($tas->advance());
    
    $pagehtml .= "</table>\n";
  }
  $outhtml .= $pagehtml;
  $outtext .= $pagetext;
};

function addwhere(&$where, $clause)
{
  $where .= $where ? " AND " : "WHERE ";
  $where .= $clause;
}

function addorder(&$order, $clause)
{
  $order .= $order ? ", " : "ORDER BY ";
  $order .= $clause;
}

function addgroup(&$group, $clause)
{
  $group .= $group ? ", " : "GROUP BY ";
  $group .= $clause;
}

function addcolumn(&$columns, $clause)
{
  $columns .= $columns ? ", " : "";
  $columns .= $clause;
}

class SegmentedQuery
{
  var $result;
  var $column;
  var $last;
  
  function SegmentedQuery($result, $column)
  {
    $this->result = $result;
    $this->column = $column;
    $this->last = false;
  }
  
  function advance()
  {
    $this->row = mysql_fetch_assoc($this->result);
    if ($this->last == $this->row[$this->column])
    {
      $this->last = $this->row[$this->column];
      return true;
    }
    else
    {
      $this->last = $this->row[$this->column];
      return false;    
    }
  }
}

function report_meter($percent)
{
  global $server_wcespath;
  $out = "<img src=\"${server_wcespath}/media/meter/left.gif\" width=6 height=13>";
  for($i = 0; $i < 5; ++$i)
  {
    $num = $percent - 20 * $i;
    if ($num < 0) $num = 0;
    if ($num < 10) $num = "0" . $num;
    if ($num > 20) $num = 20;
    $out .= "<img src=\"${server_wcespath}media/meter/mid${num}.gif\" width=21 height=13>";
  };
  $out .= "<img src=\"${server_wcespath}media/meter/right.gif\" width=5 height=13>";
  return $out;
};

function report_mode($distribution)
{
  $max = $maxv = false;
  foreach($distribution as $score => $people)
  if ($max === false || $people >= $maxv) 
  {
    $max = $score;
    $maxv = $people;
  }
  return $max;
}

function report_avg($distribution)
{
  $sum = $wsum = 0;
  foreach($distribution as $score => $people)
  {
    $sum += $people;
    $wsum += $score * $people;
  }
  return $sum == 0 ? 0 : $wsum / $sum;
}

function report_sd($distribution, $avg)
{
  $sum = $wsum = 0;
  foreach($distribution as $score => $people)
  {
    $sum += $score;
    $wsum += $people * pow(($score - $avg),2);
  }
  return $sum == 0 ? 0 : sqrt($wsum/$sum);
}

%>